import os
import subprocess
import argparse
import shutil
from concurrent.futures import ThreadPoolExecutor

def install_dependencies():
    try:
        # Install dependencies
        subprocess.run(["sudo", "apt-get", "install", "-y", "john", "hash-identifier", "stegseek", "pkcrack"], check=True)
        # Create required directories
        os.makedirs("Jailbreak/Jailhouse/steg_result", exist_ok=True)
        os.makedirs("Jailbreak/Jailhouse/hashfile", exist_ok=True)
        os.makedirs("Jailbreak/wordlist", exist_ok=True)
        os.makedirs("Jailbreak/Freedom", exist_ok=True)
        
        # Move the wordlists to the wordlist directory
        wordlists = ["rockyou.txt", "betterrockyou.txt", "brockyou++.txt"]
        for wordlist in wordlists:
            wordlist_source = wordlist
            wordlist_destination = f"Jailbreak/wordlist/{wordlist}"
            shutil.move(wordlist_source, wordlist_destination)
        
        print("Dependencies installed, directories created, and wordlists moved successfully.")
    except subprocess.CalledProcessError as e:
        print(f"Failed to install dependencies: {e}")
    except OSError as e:
        print(f"Failed to create directories or move the wordlists: {e}")

def run_stegseek(filepath, wordlist_path, steg_result_file):
    try:
        subprocess.run(["stegseek", filepath, wordlist_path, "-o", steg_result_file], check=True)
        return True
    except subprocess.CalledProcessError:
        return False

def run_john(hashfile, wordlist_path, john_output_file):
    try:
        subprocess.run(["john", "--wordlist=" + wordlist_path, hashfile, "--pot=" + john_output_file], check=True)
        return True
    except subprocess.CalledProcessError:
        return False

def run_pkcrack(encrypted_zip, plaintext_zip, decrypted_file):
    try:
        subprocess.run(["pkcrack", "-C", encrypted_zip, "-c", "ciphertextname", "-P", plaintext_zip, "-p", "plaintextname", "-d", decrypted_file], check=True)
        return True
    except subprocess.CalledProcessError:
        return False

def process_file(args):
    filename, known_hash, known_encrypt = args['filename'], args['hash'], args['encrypt']
    try:
        filepath = os.path.join("Jailbreak/Jailhouse", filename)
        if os.path.isfile(filepath):
            steg_result_file = f"Jailbreak/Jailhouse/steg_result/{filename}_steg_result.txt"
            hashfile = f"Jailbreak/Jailhouse/hashfile/{filename}_hashfile.txt"
            john_output_file = f"Jailbreak/Freedom/{filename}_cracked.txt"
            decrypted_file = f"Jailbreak/Freedom/{filename}_decrypted.zip"

            wordlists = ["Jailbreak/wordlist/rockyou.txt", "Jailbreak/wordlist/betterrockyou.txt", "Jailbreak/wordlist/brockyou++.txt"]

            # Run stegseek with escalation
            stegseek_success = False
            for wordlist in wordlists:
                if run_stegseek(filepath, wordlist, steg_result_file):
                    stegseek_success = True
                    break

            if stegseek_success or known_hash:
                # Run hash-identifier if hash type is unknown
                if not known_hash:
                    with open(hashfile, "w") as f:
                        subprocess.run(["hash-identifier", filepath], stdout=f, check=True)

                # Run John the Ripper with escalation if encryption is known
                if known_encrypt:
                    for wordlist in wordlists:
                        if run_john(hashfile, wordlist, john_output_file):
                            break

            # Run pkcrack if the file is a ZIP archive and encryption is unknown
            if filename.endswith(".zip") and not known_encrypt:
                plaintext_zip = "path/to/plaintext.zip"  # Update with the actual path to the plaintext ZIP
                run_pkcrack(filepath, plaintext_zip, decrypted_file)
    except FileNotFoundError as e:
        print(f"File not found: {e}")
    except PermissionError as e:
        print(f"Permission denied: {e}")
    except OSError as e:
        print(f"OS error: {e}")

def jailbreak():
    try:
        filenames = os.listdir("Jailbreak/Jailhouse")
        
        known_info = {}
        for filename in filenames:
            print(f"What do we know about {filename}? (leave blank if unknown)")
            known_hash = input("Hash: ")
            known_encrypt = input("Encryption: ")
            known_info[filename] = {'filename': filename, 'hash': known_hash if known_hash else None, 'encrypt': known_encrypt if known_encrypt else None}

        with ThreadPoolExecutor() as executor:
            executor.map(lambda filename: process_file(known_info[filename]), filenames)
    except FileNotFoundError as e:
        print(f"Directory not found: {e}")
    except PermissionError as e:
        print(f"Permission denied: {e}")
    except OSError as e:
        print(f"OS error: {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Jailbreak program")
    parser.add_argument("command", choices=["install", "jailbreak"], help="Command to run")

    args = parser.parse_args()

    if args.command == "install":
        install_dependencies()
    elif args.command == "jailbreak":
        jailbreak()